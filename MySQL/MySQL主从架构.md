# MySQL主从复制

[TOC]

## 简介

- **原理**：将主服务器的binlog日志复制到从服务器上执行一遍，达到主从数据的一致状态。
- **过程**：从库开启一个I/O线程，向主库请求Binlog日志。主节点开启一个binlog dump线程，检查自己的二进制日志，并发送给从节点；从库将接收到的数据保存到中继日志（Relay log）中，另外开启一个SQL线程，把Relay中的操作在自身机器上执行一遍
- **优点**： 
  - 作为备用数据库，并且不影响业务
  - 可做读写分离，一个写库，一个或多个读库，在不同的服务器上，充分发挥服务器和数据库的性能，但要保证数据的一致性



**binlog记录格式：**statement、row、mixed

 基于语句statement的复制、基于行row的复制、基于语句和行（mix）的复制。其中基于row的复制方式更能保证主从库数据的一致性，但日志量较大，在设置时考虑磁盘的空间问题



![](images/20190520173057978.png)

- **异步复制（默认）**：`MySQL` 默认的复制策略，`Master`处理事务过程中，将其写入`Binlog`就会通知`Dump thread`线程处理，然后完成事务的提交，不会关心是否成功发送到任意一个`slave`中。
- **半同步复制**：`Master`处理事务过程中，提交完事务后，必须**等至少一个**`Slave`将收到的`binlog`写入`relay log`返回`ack`（提交后才同步）才能继续执行处理用户的事务。
- **增强半同步复制**：半同步的问题是因为等待`ACK`的点是`Commit`之后，此时`Master`已经完成数据变更，用户已经可以看到最新数据，当`Binlog`还未同步到`Slave`时，发生主从切换，那么此时从库是没有这个最新数据的，用户又看到老数据。增强半同步将等待`ACK`的点放在提交`Commit`之前（同步后再提交），此时数据还未被提交，外界看不到数据变更，此时如果发送主从切换，新库依然还是老数据，不存在数据不一致的问题。
- **组复制**：`MySQL`在引擎层完成`Prepare`操作写`Redo`日志之后，会被`MySQL`的预设`Hook`拦截进入`MGR`层，`MGR`层将事务信息打包通过`Paxos`协议发送到全部节点上，只要集群中过半节点回复`ACK`（半数写成功），那么将告诉所有节点数据包同步成功，然后每个节点开始自己认证（`certify`）通过就开始写`Binlog`，提交事务或者写`relay log`，数据同步，如果认证不通过则`rollback`。









## 数据一致性问题

